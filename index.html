<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RESIDENCIA TESO DE CABRERIZOS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header-card { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 30px; text-align: center; border: 3px solid #4f46e5; position: relative; }
        .logo { width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .header-card h1 { color: #1e293b; font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .header-card p { color: #64748b; font-size: 1.2em; }
        .header-buttons { position: absolute; top: 30px; right: 30px; display: flex; gap: 10px; }
        .reload-btn { padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); transition: all 0.3s; }
        .reload-btn:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6); }
        .print-btn { padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); transition: all 0.3s; }
        .print-btn:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6); }
        
        /* Estilos para impresi√≥n */
        @media print {
            body { background: white; padding: 0; }
            .header-buttons, .reload-btn, .print-btn, .info-banner { display: none !important; }
            .container { max-width: 100%; }
            .header-card { box-shadow: none; border: 1px solid #e2e8f0; page-break-inside: avoid; }
            .selector-card { box-shadow: none; border: 1px solid #e2e8f0; padding: 15px; page-break-inside: avoid; }
            .selectors-grid { grid-template-columns: 1fr; gap: 10px; }
            .stats-grid { grid-template-columns: repeat(4, 1fr); gap: 10px; page-break-inside: avoid; }
            .stat-card { box-shadow: none; border: 1px solid #e2e8f0; padding: 15px; }
            .charts-grid { grid-template-columns: 1fr; gap: 15px; }
            .chart-card { box-shadow: none; border: 1px solid #e2e8f0; padding: 15px; page-break-inside: avoid; }
            .chart-wrapper { height: 250px !important; }
            .chart-combined .chart-wrapper { height: 300px !important; }
            .chart-combined { page-break-before: always; }
        }
        .info-banner { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 5px solid #0ea5e9; padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .info-banner strong { color: #0369a1; font-size: 1.1em; }
        .selector-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; }
        .selector-label { font-size: 1.2em; font-weight: 600; color: #1e293b; margin-bottom: 15px; display: block; }
        .selectors-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        select { width: 100%; padding: 18px 24px; font-size: 1.1em; border: 3px solid #e2e8f0; border-radius: 15px; background: white; cursor: pointer; transition: all 0.3s; color: #1e293b; }
        select:hover { border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); }
        select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2); }
        select:disabled { background: #f1f5f9; cursor: not-allowed; border-color: #cbd5e1; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center; transition: transform 0.3s, box-shadow 0.3s; border-top: 5px solid #667eea; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.25); }
        .stat-card h3 { color: #64748b; font-size: 0.9em; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .stat-card .value { color: #1e293b; font-size: 3em; font-weight: 700; line-height: 1; }
        .stat-card .trend { margin-top: 15px; font-size: 1em; font-weight: 600; }
        .trend.up { color: #10b981; }
        .trend.down { color: #ef4444; }
        .trend.neutral { color: #f59e0b; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .chart-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transition: transform 0.3s; }
        .chart-card:hover { transform: translateY(-5px); }
        .chart-card h2 { color: #1e293b; margin-bottom: 20px; font-size: 1.4em; text-align: center; font-weight: 600; }
        .chart-wrapper { position: relative; height: 300px; }
        .chart-combined { grid-column: 1 / -1; }
        .chart-combined .chart-wrapper { height: 400px; }
        .loading { text-align: center; padding: 60px; background: white; border-radius: 20px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .loading-spinner { border: 5px solid #f3f4f6; border-top: 5px solid #667eea; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-data { text-align: center; padding: 80px 20px; color: #64748b; font-size: 1.3em; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .error-message { background: #fee2e2; color: #991b1b; padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid #ef4444; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); }
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .chart-combined { grid-column: 1; }
            .stats-grid { grid-template-columns: 1fr; }
            .selectors-grid { grid-template-columns: 1fr; }
            .header-buttons { position: relative; top: auto; right: auto; margin-top: 20px; flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-card">
            <div class="header-buttons">
                <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                <button class="reload-btn" onclick="cargarDatos()">üîÑ Recargar Datos</button>
            </div>
            <div class="logo">üè•</div>
            <h1>Dashboard - RESIDENCIA TESO DE CABRERIZOS</h1>
            <p>Sistema de Seguimiento Integrado</p>
        </div>
        <div id="loadingIndicator" class="loading">
            <div class="loading-spinner"></div>
            <p style="color: #1e293b; font-size: 1.2em; font-weight: 600;">Cargando datos desde Google Sheets...</p>
        </div>
        <div id="errorContainer" style="display: none;"></div>
        <div id="infoBox" class="info-banner" style="display: none;">
            <strong>üìä Datos cargados:</strong> <span id="infoText"></span>
        </div>
        <div class="selector-card" id="selectorCard" style="display: none;">
            <div class="selectors-grid">
                <div>
                    <label class="selector-label">1Ô∏è‚É£ Seleccionar Programa:</label>
                    <select id="programSelect">
                        <option value="">-- Seleccione un programa --</option>
                        <option value="grua">GR√öA</option>
                        <option value="paralelas">PARALELAS</option>
                        <option value="ayuda">AYUDA PROFESIONAL</option>
                    </select>
                </div>
                <div>
                    <label class="selector-label">2Ô∏è‚É£ Seleccionar Per√≠odo:</label>
                    <select id="periodSelect" disabled>
                        <option value="">-- Primero seleccione un programa --</option>
                        <option value="1mes">√öltimo mes</option>
                        <option value="3meses">√öltimos 3 meses</option>
                        <option value="6meses">√öltimos 6 meses</option>
                        <option value="1ano">√öltimo a√±o</option>
                        <option value="todo">Todo el hist√≥rico</option>
                    </select>
                </div>
                <div>
                    <label class="selector-label">3Ô∏è‚É£ Seleccionar Residente:</label>
                    <select id="residentSelect" disabled>
                        <option value="">-- Seleccione programa y per√≠odo --</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="stats-grid" id="statsContainer" style="display: none;">
            <div class="stat-card"><h3>Total Registros</h3><div class="value" id="totalRegistros">0</div></div>
            <div class="stat-card"><h3>Promedio Pulsiones</h3><div class="value" id="avgPulsiones">0</div></div>
            <div class="stat-card"><h3>Promedio Tiempo (seg)</h3><div class="value" id="avgTiempo">0</div></div>
            <div class="stat-card"><h3>Tendencia</h3><div class="value trend" id="tendencia">--</div></div>
        </div>
        <div class="charts-grid" id="chartsContainer">
            <div class="no-data">Los datos se cargar√°n autom√°ticamente desde Google Sheets...</div>
        </div>
    </div>
    <script>
        const SHEET_ID = '1ZT_ngjAyJ-UNMafxXRFaNvJ1hr_S8gnDrae19Ci';
        const SHEET_URLS = {
            grua: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSBnSzm5rogm5whxu2wqkTxc67abg6ggEWKQiQzf5KqKJV_BDLL5shULXsKh78THGh-Ju_de0QiK1Om/pub?gid=0&single=true&output=csv',
            paralelas: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSBnSzm5rogm5whxu2wqkTxc67abg6ggEWKQiQzf5KqKJV_BDLL5shULXsKh78THGh-Ju_de0QiK1Om/pub?gid=845093310&single=true&output=csv',
            ayuda: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSBnSzm5rogm5whxu2wqkTxc67abg6ggEWKQiQzf5KqKJV_BDLL5shULXsKh78THGh-Ju_de0QiK1Om/pub?gid=276770712&single=true&output=csv'
        };
        
        let allData = {};
        let charts = {};
        let programaActual = '';
        let periodoActual = '';
        
        function cargarDatos() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('selectorCard').style.display = 'none';
            document.getElementById('infoBox').style.display = 'none';
            
            let cargados = 0;
            const total = 3;
            
            Object.entries(SHEET_URLS).forEach(([programa, url]) => {
                console.log(`üîÑ Cargando ${programa.toUpperCase()}:`, url);
                
                Papa.parse(url, {
                    download: true,
                    header: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log(`‚úÖ ${programa.toUpperCase()} recibido, total filas:`, results.data.length);
                        allData[programa] = procesarHoja(results.data, programa);
                        cargados++;
                        
                        if (cargados === total) {
                            finalizarCarga();
                        }
                    },
                    error: function(error) {
                        console.error(`‚ùå Error cargando ${programa}:`, error);
                        mostrarError(`Error al cargar datos de ${programa.toUpperCase()}`);
                    }
                });
            });
        }
        
        function procesarHoja(data, programa) {
            let headerIndex = -1;
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                for (let j = 0; j < row.length; j++) {
                    const cell = row[j] ? row[j].toString().trim().toUpperCase() : '';
                    if (cell === 'FECHA' || cell.includes('FECHA')) {
                        headerIndex = i;
                        console.log(`‚úÖ ${programa.toUpperCase()} - Encabezados en fila:`, i);
                        break;
                    }
                }
                if (headerIndex !== -1) break;
            }
            
            if (headerIndex === -1) {
                console.log(`‚ö†Ô∏è ${programa.toUpperCase()} - No se encontraron encabezados`);
                return [];
            }
            
            let headers = data[headerIndex];
            headers = headers.map(h => h ? h.toString().replace(/GRUA |PARALELAS |AYUDA PROFESIONAL /gi, '').trim() : h);
            
            const dataRows = data.slice(headerIndex + 1).filter(row => {
                return row.some(cell => cell && cell.toString().trim() !== '');
            });
            
            console.log(`${programa.toUpperCase()} - Encabezados:`, headers);
            console.log(`${programa.toUpperCase()} - Filas de datos:`, dataRows.length);
            
            const processedData = [];
            dataRows.forEach(row => {
                const apellido1 = (row[headers.indexOf('APELLIDO 1')] || row[headers.indexOf('APELLIDO1')] || '').toString().trim();
                const apellido2 = (row[headers.indexOf('APELLIDO 2')] || row[headers.indexOf('APELLIDO2')] || '').toString().trim();
                const nombre = (row[headers.indexOf('NOMBRE')] || '').toString().trim();
                
                if (apellido1 && apellido2 && nombre) {
                    const nombreCompleto = `${nombre} ${apellido1} ${apellido2}`.toLowerCase().trim();
                    const fecha = (row[headers.indexOf('FECHA')] || '').toString().trim();
                    const supervisor = (row[headers.indexOf('SUPERVISOR')] || '').toString().trim();
                    
                    // Buscar columnas de pulsiones/propulsiones
                    let pulsiones = 0;
                    for (let i = 0; i < headers.length; i++) {
                        const h = headers[i].toUpperCase();
                        if (h.includes('PULSIONES') || h.includes('PROPULSIONES')) {
                            pulsiones = parseInt(row[i] || 0);
                            break;
                        }
                    }
                    
                    // Buscar columna de tiempo
                    let tiempo = 0;
                    for (let i = 0; i < headers.length; i++) {
                        const h = headers[i].toUpperCase();
                        if (h.includes('TIEMPO') && h.includes('TOLERADO')) {
                            tiempo = parseInt(row[i] || 0);
                            break;
                        }
                    }
                    
                    const observaciones = (row[headers.indexOf('OBSERVACIONES CLINICAS')] || row[headers.indexOf('OBSERVACIONES CL√çNICAS')] || '').toString().trim();
                    
                    if (fecha && pulsiones > 0 && tiempo > 0) {
                        processedData.push({
                            fecha,
                            nombre: nombreCompleto,
                            supervisor,
                            pulsiones,
                            tiempo,
                            observaciones
                        });
                    }
                }
            });
            
            console.log(`‚úÖ ${programa.toUpperCase()} - Total procesados:`, processedData.length);
            return processedData;
        }
        
        function finalizarCarga() {
            document.getElementById('loadingIndicator').style.display = 'none';
            
            const totalRegistros = Object.values(allData).reduce((sum, arr) => sum + arr.length, 0);
            
            if (totalRegistros === 0) {
                document.getElementById('chartsContainer').innerHTML = '<div class="no-data">üìã No hay datos en las hojas<br><br>A√±ade datos al Google Sheet</div>';
                return;
            }
            
            document.getElementById('selectorCard').style.display = 'block';
            document.getElementById('infoBox').style.display = 'block';
            document.getElementById('infoText').textContent = `${totalRegistros} registros totales | GR√öA: ${allData.grua.length} | PARALELAS: ${allData.paralelas.length} | AYUDA: ${allData.ayuda.length}`;
        }
        
        function mostrarError(mensaje) {
            document.getElementById('loadingIndicator').style.display = 'none';
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">‚ö†Ô∏è ${mensaje}</div>`;
            errorContainer.style.display = 'block';
        }
        
        function formatFecha(fecha) {
            if (!fecha) return '';
            try {
                const partes = fecha.split('/');
                if (partes.length === 3) {
                    const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
                    return `${partes[0]} ${meses[parseInt(partes[1])-1]}`;
                }
                return fecha;
            } catch(e) { return fecha; }
        }
        
        function calcularTendencia(datos) {
            if (datos.length < 2) return 'neutral';
            const ultimo = datos[datos.length-1];
            const primero = datos[0];
            const difP = ultimo.pulsiones - primero.pulsiones;
            const difT = ultimo.tiempo - primero.tiempo;
            if (difP > 0 && difT > 0) return 'up';
            if (difP < 0 || difT < 0) return 'down';
            return 'neutral';
        }
        
        // Funci√≥n para parsear fechas en formato DD/MM/YYYY
        function parseFecha(fechaStr) {
            const partes = fechaStr.split('/');
            if (partes.length === 3) {
                return new Date(partes[2], partes[1] - 1, partes[0]);
            }
            return new Date(fechaStr);
        }
        
        // Funci√≥n para filtrar datos por per√≠odo
        function filtrarPorPeriodo(datos, periodo) {
            const ahora = new Date();
            let fechaInicio;
            
            switch(periodo) {
                case '1mes':
                    // √öltimo mes: desde el d√≠a 1 del mes anterior
                    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth() - 1, 1);
                    break;
                case '3meses':
                    // √öltimos 3 meses: desde el d√≠a 1 de hace 3 meses
                    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth() - 3, 1);
                    break;
                case '6meses':
                    // √öltimos 6 meses: desde el d√≠a 1 de hace 6 meses
                    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth() - 6, 1);
                    break;
                case '1ano':
                    // √öltimo a√±o: desde el d√≠a 1 de hace 12 meses
                    fechaInicio = new Date(ahora.getFullYear() - 1, ahora.getMonth(), 1);
                    break;
                case 'todo':
                    return datos; // Devolver todos los datos
                default:
                    return datos;
            }
            
            return datos.filter(d => {
                const fecha = parseFecha(d.fecha);
                return fecha >= fechaInicio;
            });
        }
        
        // Funci√≥n para agrupar datos
        function agruparDatos(datos, periodo) {
            if (periodo === '1mes' || datos.length <= 31) {
                // Para √∫ltimo mes o pocos datos: mostrar cada d√≠a
                return datos.map(d => ({
                    label: formatFecha(d.fecha),
                    pulsiones: d.pulsiones,
                    tiempo: d.tiempo,
                    count: 1
                }));
            } else if (periodo === '3meses') {
                // Para 3 meses: agrupar por semanas
                const grupos = {};
                datos.forEach(d => {
                    const fecha = parseFecha(d.fecha);
                    const semana = getWeekNumber(fecha);
                    const ano = fecha.getFullYear();
                    const mes = fecha.getMonth();
                    const key = `${ano}-S${semana}`;
                    
                    if (!grupos[key]) {
                        grupos[key] = {
                            label: `S${semana} ${getMesAbreviado(mes)}`,
                            pulsiones: 0,
                            tiempo: 0,
                            count: 0
                        };
                    }
                    grupos[key].pulsiones += d.pulsiones;
                    grupos[key].tiempo += d.tiempo;
                    grupos[key].count++;
                });
                
                return Object.values(grupos).map(g => ({
                    label: g.label,
                    pulsiones: Math.round(g.pulsiones / g.count),
                    tiempo: Math.round(g.tiempo / g.count),
                    count: g.count
                }));
            } else {
                // Para 6 meses, 1 a√±o o todo: agrupar por meses
                const grupos = {};
                datos.forEach(d => {
                    const fecha = parseFecha(d.fecha);
                    const key = `${fecha.getFullYear()}-${fecha.getMonth()}`;
                    const mesAbr = getMesAbreviado(fecha.getMonth());
                    
                    if (!grupos[key]) {
                        grupos[key] = {
                            label: mesAbr,
                            pulsiones: 0,
                            tiempo: 0,
                            count: 0,
                            orden: fecha.getTime()
                        };
                    }
                    grupos[key].pulsiones += d.pulsiones;
                    grupos[key].tiempo += d.tiempo;
                    grupos[key].count++;
                });
                
                return Object.values(grupos)
                    .sort((a, b) => a.orden - b.orden)
                    .map(g => ({
                        label: g.label,
                        pulsiones: Math.round(g.pulsiones / g.count),
                        tiempo: Math.round(g.tiempo / g.count),
                        count: g.count
                    }));
            }
        }
        
        // Funci√≥n auxiliar para obtener el n√∫mero de semana
        function getWeekNumber(fecha) {
            const d = new Date(Date.UTC(fecha.getFullYear(), fecha.getMonth(), fecha.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        // Funci√≥n auxiliar para obtener mes abreviado
        function getMesAbreviado(mes) {
            const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
            return meses[mes];
        }
        
        function calcularTendencia(datos) {
            if (datos.length < 2) return 'neutral';
            const ultimo = datos[datos.length-1];
            const primero = datos[0];
            const difP = ultimo.pulsiones - primero.pulsiones;
            const difT = ultimo.tiempo - primero.tiempo;
            if (difP > 0 && difT > 0) return 'up';
            if (difP < 0 || difT < 0) return 'down';
            return 'neutral';
        }
        
        function actualizarEstadisticas(datos) {
            const total = datos.length;
            const avgP = (datos.reduce((s,d) => s + d.pulsiones, 0) / total).toFixed(1);
            const avgT = (datos.reduce((s,d) => s + d.tiempo, 0) / total).toFixed(1);
            const tend = calcularTendencia(datos);
            document.getElementById('totalRegistros').textContent = total;
            document.getElementById('avgPulsiones').textContent = avgP;
            document.getElementById('avgTiempo').textContent = avgT;
            const tendEl = document.getElementById('tendencia');
            tendEl.className = `value trend ${tend}`;
            tendEl.textContent = tend==='up' ? '‚Üë Mejorando' : tend==='down' ? '‚Üì Requiere atenci√≥n' : '‚Üí Estable';
        }
        
        function destruirGraficas() {
            Object.values(charts).forEach(c => c.destroy());
            charts = {};
        }
        
        function crearGraficas(residente, programa, periodo) {
            destruirGraficas();
            
            // Obtener datos del residente
            let datosR = allData[programa].filter(d => d.nombre === residente).sort((a,b) => {
                const [dA,mA,yA] = a.fecha.split('/');
                const [dB,mB,yB] = b.fecha.split('/');
                return new Date(yA,mA-1,dA) - new Date(yB,mB-1,dB);
            });
            
            if (datosR.length === 0) return;
            
            // Filtrar por per√≠odo
            datosR = filtrarPorPeriodo(datosR, periodo);
            
            if (datosR.length === 0) {
                document.getElementById('chartsContainer').innerHTML = '<div class="no-data">No hay datos para el per√≠odo seleccionado</div>';
                return;
            }
            
            // Agrupar datos seg√∫n el per√≠odo
            const datosAgrupados = agruparDatos(datosR, periodo);
            
            // Calcular estad√≠sticas con datos originales (no agrupados)
            actualizarEstadisticas(datosR);
            document.getElementById('statsContainer').style.display = 'grid';
            
            const fechas = datosAgrupados.map(d => d.label);
            const puls = datosAgrupados.map(d => d.pulsiones);
            const tiempos = datosAgrupados.map(d => d.tiempo);
            
            const labelPulsiones = programa === 'grua' ? 'Propulsiones' : 'Pulsiones';
            const container = document.getElementById('chartsContainer');
            container.innerHTML = `
                <div class="chart-card"><h2>üìà Evoluci√≥n N.¬∫ ${labelPulsiones}</h2><div class="chart-wrapper"><canvas id="cp"></canvas></div></div>
                <div class="chart-card"><h2>‚è±Ô∏è Evoluci√≥n Tiempo Tolerado</h2><div class="chart-wrapper"><canvas id="ct"></canvas></div></div>
                <div class="chart-card chart-combined"><h2>üìä Evoluci√≥n Combinada</h2><div class="chart-wrapper"><canvas id="cc"></canvas></div></div>
            `;
            
            charts.p = new Chart(document.getElementById('cp').getContext('2d'), {
                type: 'line',
                data: { labels: fechas, datasets: [{ label: labelPulsiones, data: puls, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', borderWidth: 3, tension: 0.4, fill: true, pointRadius: 8, pointHoverRadius: 10, pointBackgroundColor: '#667eea', pointBorderColor: '#fff', pointBorderWidth: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: `N√∫mero de ${labelPulsiones}`, font: { size: 14, weight: 'bold' } }, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } } }
            });
            
            charts.t = new Chart(document.getElementById('ct').getContext('2d'), {
                type: 'line',
                data: { labels: fechas, datasets: [{ label: 'Tiempo (seg)', data: tiempos, borderColor: '#764ba2', backgroundColor: 'rgba(118,75,162,0.1)', borderWidth: 3, tension: 0.4, fill: true, pointRadius: 8, pointHoverRadius: 10, pointBackgroundColor: '#764ba2', pointBorderColor: '#fff', pointBorderWidth: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Segundos', font: { size: 14, weight: 'bold' } }, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } } }
            });
            
            charts.c = new Chart(document.getElementById('cc').getContext('2d'), {
                type: 'line',
                data: { labels: fechas, datasets: [
                    { label: labelPulsiones, data: puls, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', borderWidth: 3, tension: 0.4, yAxisID: 'y', pointRadius: 8, pointHoverRadius: 10, pointBackgroundColor: '#667eea', pointBorderColor: '#fff', pointBorderWidth: 3 },
                    { label: 'Tiempo (seg)', data: tiempos, borderColor: '#764ba2', backgroundColor: 'rgba(118,75,162,0.1)', borderWidth: 3, tension: 0.4, yAxisID: 'y1', pointRadius: 8, pointHoverRadius: 10, pointBackgroundColor: '#764ba2', pointBorderColor: '#fff', pointBorderWidth: 3 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: true, position: 'bottom', labels: { padding: 20, font: { size: 14, weight: 'bold' }, usePointStyle: true, pointStyle: 'circle' } } }, scales: { y: { type: 'linear', display: true, position: 'left', title: { display: true, text: labelPulsiones, color: '#667eea', font: { size: 14, weight: 'bold' } }, grid: { color: 'rgba(102,126,234,0.1)' } }, y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Tiempo (seg)', color: '#764ba2', font: { size: 14, weight: 'bold' } }, grid: { drawOnChartArea: false } }, x: { grid: { display: false } } } }
            });
        }
        
        // Event listener para selector de programa
        document.getElementById('programSelect').addEventListener('change', (e) => {
            programaActual = e.target.value;
            const periodSelect = document.getElementById('periodSelect');
            const residentSelect = document.getElementById('residentSelect');
            
            if (programaActual && allData[programaActual]) {
                // Activar selector de per√≠odo
                periodSelect.disabled = false;
                periodSelect.innerHTML = `
                    <option value="">-- Seleccione un per√≠odo --</option>
                    <option value="1mes">√öltimo mes</option>
                    <option value="3meses">√öltimos 3 meses</option>
                    <option value="6meses">√öltimos 6 meses</option>
                    <option value="1ano">√öltimo a√±o</option>
                    <option value="todo">Todo el hist√≥rico</option>
                `;
                
                // Resetear selecci√≥n de per√≠odo y residente
                periodoActual = '';
                residentSelect.disabled = true;
                residentSelect.innerHTML = '<option value="">-- Seleccione programa y per√≠odo --</option>';
                
                destruirGraficas();
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('chartsContainer').innerHTML = `<div class="no-data">Seleccione un per√≠odo</div>`;
            } else {
                periodSelect.innerHTML = '<option value="">-- Primero seleccione un programa --</option>';
                periodSelect.disabled = true;
                residentSelect.innerHTML = '<option value="">-- Seleccione programa y per√≠odo --</option>';
                residentSelect.disabled = true;
                destruirGraficas();
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('chartsContainer').innerHTML = '<div class="no-data">Seleccione un programa</div>';
            }
        });
        
        // Event listener para selector de per√≠odo
        document.getElementById('periodSelect').addEventListener('change', (e) => {
            periodoActual = e.target.value;
            const residentSelect = document.getElementById('residentSelect');
            
            if (periodoActual && programaActual && allData[programaActual]) {
                const residentes = [...new Set(allData[programaActual].map(d => d.nombre))].sort();
                residentSelect.innerHTML = '<option value="">-- Seleccione un residente --</option>';
                residentes.forEach(nombre => {
                    const option = document.createElement('option');
                    option.value = nombre;
                    option.textContent = nombre.split(' ').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                    residentSelect.appendChild(option);
                });
                residentSelect.disabled = false;
                
                destruirGraficas();
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('chartsContainer').innerHTML = `<div class="no-data">‚úÖ ${allData[programaActual].length} registros de ${residentes.length} residentes<br><br>Seleccione un residente</div>`;
            } else {
                residentSelect.innerHTML = '<option value="">-- Seleccione programa y per√≠odo --</option>';
                residentSelect.disabled = true;
                destruirGraficas();
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('chartsContainer').innerHTML = '<div class="no-data">Seleccione un per√≠odo</div>';
            }
        });
        
        // Event listener para selector de residente
        document.getElementById('residentSelect').addEventListener('change', (e) => {
            const res = e.target.value;
            if (res && programaActual && periodoActual) {
                crearGraficas(res, programaActual, periodoActual);
            } else {
                destruirGraficas();
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('chartsContainer').innerHTML = '<div class="no-data">Seleccione un residente</div>';
            }
        });
        
        cargarDatos();
    </script>
</body>
</html>
